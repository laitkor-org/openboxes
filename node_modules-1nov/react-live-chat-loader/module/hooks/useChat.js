import { useContext, useCallback, useEffect } from 'react';
import { LiveChatLoaderContext } from "../context";
import * as Providers from "../providers";
const requestIdleCallback = typeof window !== 'undefined' ? window.requestIdleCallback : null;
const connection = typeof window !== 'undefined' ? // eslint-disable-next-line @typescript-eslint/no-explicit-any
window.navigator && window.navigator.connection : null;
let scriptLoaded = false;

const useChat = ({
  loadWhenIdle
} = {
  loadWhenIdle: false
}) => {
  const {
    provider,
    providerKey,
    idlePeriod,
    state,
    setState,
    appID,
    locale
  } = useContext(LiveChatLoaderContext);
  useEffect(() => {
    // Don't load if idlePeriod is 0, null or undefined
    if (typeof window === 'undefined' || !loadWhenIdle || !idlePeriod) return; // Don't load if 2g connection or save-data is enabled

    if (connection && (connection.saveData || /2g/.test(connection.effectiveType))) return;
    if (isNaN(idlePeriod)) return; // deadline.timeRemaining() has an upper limit of 50 milliseconds
    // We want to ensure the page has been idle for a significant period of time
    // Therefore we count consecutive maximum timeRemaining counts and load chat when we reach our threshold

    let elapsedIdlePeriod = 0;
    let previousTimeRemaining = 0;

    const scheduleLoadChat = deadline => {
      if (elapsedIdlePeriod > idlePeriod) return loadChat({
        open: false
      });
      const timeRemaining = deadline.timeRemaining(); // To ensure browser is idle, only accumalte elapsedIdlePeriod when
      // two consecutive maximum timeRemaining's have been observed

      if (previousTimeRemaining > 49 && timeRemaining > 49) elapsedIdlePeriod += timeRemaining;
      previousTimeRemaining = timeRemaining;
      requestIdleCallback === null || requestIdleCallback === void 0 ? void 0 : requestIdleCallback(scheduleLoadChat);
    };

    if (requestIdleCallback) {
      requestIdleCallback(scheduleLoadChat);
    } else {
      setTimeout(() => loadChat({
        open: false
      }), idlePeriod);
    }
  }, []);
  const chatProvider = Providers[provider];
  const loadChat = useCallback(({
    open = true
  }) => {
    if (!providerKey) {
      //eslint-disable-next-line no-console
      console.error('No api key given to react-live-chat-loader');
      return;
    }

    if (!provider) {
      //eslint-disable-next-line no-console
      console.error('No provider given to react-live-chat-loader');
      return;
    }

    if (state === 'opening') return;
    if (state === 'open') return chatProvider.close();
    if (state === 'complete') return chatProvider.open();

    if (!scriptLoaded) {
      scriptLoaded = true;
      chatProvider.load({
        providerKey,
        setState,
        appID,
        locale
      });
    }

    if (open) {
      setState('opening');
      chatProvider.open();
      setState('open');
    }
  }, []);
  return [state, loadChat];
};

export default useChat;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9ob29rcy91c2VDaGF0LnRzIl0sIm5hbWVzIjpbInVzZUNvbnRleHQiLCJ1c2VDYWxsYmFjayIsInVzZUVmZmVjdCIsIkxpdmVDaGF0TG9hZGVyQ29udGV4dCIsIlByb3ZpZGVycyIsInJlcXVlc3RJZGxlQ2FsbGJhY2siLCJ3aW5kb3ciLCJjb25uZWN0aW9uIiwibmF2aWdhdG9yIiwic2NyaXB0TG9hZGVkIiwidXNlQ2hhdCIsImxvYWRXaGVuSWRsZSIsInByb3ZpZGVyIiwicHJvdmlkZXJLZXkiLCJpZGxlUGVyaW9kIiwic3RhdGUiLCJzZXRTdGF0ZSIsImFwcElEIiwibG9jYWxlIiwic2F2ZURhdGEiLCJ0ZXN0IiwiZWZmZWN0aXZlVHlwZSIsImlzTmFOIiwiZWxhcHNlZElkbGVQZXJpb2QiLCJwcmV2aW91c1RpbWVSZW1haW5pbmciLCJzY2hlZHVsZUxvYWRDaGF0IiwiZGVhZGxpbmUiLCJsb2FkQ2hhdCIsIm9wZW4iLCJ0aW1lUmVtYWluaW5nIiwic2V0VGltZW91dCIsImNoYXRQcm92aWRlciIsImNvbnNvbGUiLCJlcnJvciIsImNsb3NlIiwibG9hZCJdLCJtYXBwaW5ncyI6IkFBQUEsU0FBU0EsVUFBVCxFQUFxQkMsV0FBckIsRUFBa0NDLFNBQWxDLFFBQW1ELE9BQW5EO0FBRUEsU0FBU0MscUJBQVQ7QUFDQSxPQUFPLEtBQUtDLFNBQVo7QUFFQSxNQUFNQyxtQkFBbUIsR0FDdkIsT0FBT0MsTUFBUCxLQUFrQixXQUFsQixHQUFnQ0EsTUFBTSxDQUFDRCxtQkFBdkMsR0FBNkQsSUFEL0Q7QUFFQSxNQUFNRSxVQUFVLEdBQ2QsT0FBT0QsTUFBUCxLQUFrQixXQUFsQixHQUNJO0FBQ0FBLE1BQU0sQ0FBQ0UsU0FBUCxJQUFxQkYsTUFBTSxDQUFDRSxTQUFSLENBQTBCRCxVQUZsRCxHQUdJLElBSk47QUFNQSxJQUFJRSxZQUFZLEdBQUcsS0FBbkI7O0FBRUEsTUFBTUMsT0FBTyxHQUFHLENBQ2Q7QUFDRUMsRUFBQUE7QUFERixJQUlJ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QWUsTUFBQUEsWUFBWSxDQUFDSCxJQUFiO0FBQ0FaLE1BQUFBLFFBQVEsQ0FBQyxNQUFELENBQVI7QUFDRDtBQUNGLEdBNUJ5QixFQTZCMUIsRUE3QjBCLENBQTVCO0FBZ0NBLFNBQU8sQ0FBQ0QsS0FBRCxFQUFRWSxRQUFSLENBQVA7QUFDRCxDQTFGRDs7QUE0RkEsZUFBZWpCLE9BQWYiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyB1c2VDb250ZXh0LCB1c2VDYWxsYmFjaywgdXNlRWZmZWN0IH0gZnJvbSAncmVhY3QnXG5pbXBvcnQgeyBTdGF0ZSB9IGZyb20gJ3R5cGVzJ1xuaW1wb3J0IHsgTGl2ZUNoYXRMb2FkZXJDb250ZXh0IH0gZnJvbSAnY29udGV4dCdcbmltcG9ydCAqIGFzIFByb3ZpZGVycyBmcm9tICdwcm92aWRlcnMnXG5cbmNvbnN0IHJlcXVlc3RJZGxlQ2FsbGJhY2sgPVxuICB0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJyA/IHdpbmRvdy5yZXF1ZXN0SWRsZUNhbGxiYWNrIDogbnVsbFxuY29uc3QgY29ubmVjdGlvbiA9XG4gIHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnXG4gICAgPyAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWV4cGxpY2l0LWFueVxuICAgICAgd2luZG93Lm5hdmlnYXRvciAmJiAod2luZG93Lm5hdmlnYXRvciBhcyBhbnkpLmNvbm5lY3Rpb25cbiAgICA6IG51bGxcblxubGV0IHNjcmlwdExvYWRlZCA9IGZhbHNlXG5cbmNvbnN0IHVzZUNoYXQgPSAoXG4gIHtcbiAgICBsb2FkV2hlbklkbGVcbiAgfToge1xuICAgIGxvYWRXaGVuSWRsZTogYm9vbGVhblxuICB9ID0geyBsb2FkV2hlbklkbGU6IGZhbHNlIH1cbik6IFtTdGF0ZSwgKHsgb3BlbiB9OiB7IG9wZW46IGJvb2xlYW4gfSkgPT4gdm9pZF0gPT4ge1xuICBjb25zdCB7XG4gICAgcHJvdmlkZXIsXG4gICAgcHJvdmlkZXJLZXksXG4gICAgaWRsZVBlcmlvZCxcbiAgICBzdGF0ZSxcbiAgICBzZXRTdGF0ZSxcbiAgICBhcHBJRCxcbiAgICBsb2NhbGVcbiAgfSA9IHVzZUNvbnRleHQoTGl2ZUNoYXRMb2FkZXJDb250ZXh0KVxuXG4gIHVzZUVmZmVjdCgoKSA9PiB7XG4gICAgLy8gRG9uJ3QgbG9hZCBpZiBpZGxlUGVyaW9kIGlzIDAsIG51bGwgb3IgdW5kZWZpbmVkXG4gICAgaWYgKHR5cGVvZiB3aW5kb3cgPT09ICd1bmRlZmluZWQnIHx8ICFsb2FkV2hlbklkbGUgfHwgIWlkbGVQZXJpb2QpIHJldHVyblxuXG4gICAgLy8gRG9uJ3QgbG9hZCBpZiAyZyBjb25uZWN0aW9uIG9yIHNhdmUtZGF0YSBpcyBlbmFibGVkXG4gICAgaWYgKFxuICAgICAgY29ubmVjdGlvbiAmJlxuICAgICAgKGNvbm5lY3Rpb24uc2F2ZURhdGEgfHwgLzJnLy50ZXN0KGNvbm5lY3Rpb24uZWZmZWN0aXZlVHlwZSkpXG4gICAgKVxuICAgICAgcmV0dXJuXG5cbiAgICBpZiAoaXNOYU4oaWRsZVBlcmlvZCkpIHJldHVyblxuXG4gICAgLy8gZGVhZGxpbmUudGltZVJlbWFpbmluZygpIGhhcyBhbiB1cHBlciBsaW1pdCBvZiA1MCBtaWxsaXNlY29uZHNcbiAgICAvLyBXZSB3YW50IHRvIGVuc3VyZSB0aGUgcGFnZSBoYXMgYmVlbiBpZGxlIGZvciBhIHNpZ25pZmljYW50IHBlcmlvZCBvZiB0aW1lXG4gICAgLy8gVGhlcmVmb3JlIHdlIGNvdW50IGNvbnNlY3V0aXZlIG1heGltdW0gdGltZVJlbWFpbmluZyBjb3VudHMgYW5kIGxvYWQgY2hhdCB3aGVuIHdlIHJlYWNoIG91ciB0aHJlc2hvbGRcbiAgICBsZXQgZWxhcHNlZElkbGVQZXJpb2QgPSAwXG4gICAgbGV0IHByZXZpb3VzVGltZVJlbWFpbmluZyA9IDBcbiAgICBjb25zdCBzY2hlZHVsZUxvYWRDaGF0ID0gKGRlYWRsaW5lOiBJZGxlRGVhZGxpbmUpID0+IHtcbiAgICAgIGlmIChlbGFwc2VkSWRsZVBlcmlvZCA+IGlkbGVQZXJpb2QpIHJldHVybiBsb2FkQ2hhdCh7IG9wZW46IGZhbHNlIH0pXG5cbiAgICAgIGNvbnN0IHRpbWVSZW1haW5pbmcgPSBkZWFkbGluZS50aW1lUmVtYWluaW5nKClcbiAgICAgIC8vIFRvIGVuc3VyZSBicm93c2VyIGlzIGlkbGUsIG9ubHkgYWNjdW1hbHRlIGVsYXBzZWRJZGxlUGVyaW9kIHdoZW5cbiAgICAgIC8vIHR3byBjb25zZWN1dGl2ZSBtYXhpbXVtIHRpbWVSZW1haW5pbmcncyBoYXZlIGJlZW4gb2JzZXJ2ZWRcbiAgICAgIGlmIChwcmV2aW91c1RpbWVSZW1haW5pbmcgPiA0OSAmJiB0aW1lUmVtYWluaW5nID4gNDkpXG4gICAgICAgIGVsYXBzZWRJZGxlUGVyaW9kICs9IHRpbWVSZW1haW5pbmdcblxuICAgICAgcHJldmlvdXNUaW1lUmVtYWluaW5nID0gdGltZVJlbWFpbmluZ1xuICAgICAgcmVxdWVzdElkbGVDYWxsYmFjaz8uKHNjaGVkdWxlTG9hZENoYXQpXG4gICAgfVxuXG4gICAgaWYgKHJlcXVlc3RJZGxlQ2FsbGJhY2spIHtcbiAgICAgIHJlcXVlc3RJZGxlQ2FsbGJhY2soc2NoZWR1bGVMb2FkQ2hhdClcbiAgICB9IGVsc2Uge1xuICAgICAgc2V0VGltZW91dCgoKSA9PiBsb2FkQ2hhdCh7IG9wZW46IGZhbHNlIH0pLCBpZGxlUGVyaW9kKVxuICAgIH1cbiAgfSwgW10pXG5cbiAgY29uc3QgY2hhdFByb3ZpZGVyID0gUHJvdmlkZXJzW3Byb3ZpZGVyXVxuXG4gIGNvbnN0IGxvYWRDaGF0ID0gdXNlQ2FsbGJhY2s8KGFyZ3M6IHsgb3BlbjogYm9vbGVhbiB9KSA9PiB2b2lkPihcbiAgICAoeyBvcGVuID0gdHJ1ZSB9KSA9PiB7XG4gICAgICBpZiAoIXByb3ZpZGVyS2V5KSB7XG4gICAgICAgIC8vZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWNvbnNvbGVcbiAgICAgICAgY29uc29sZS5lcnJvcignTm8gYXBpIGtleSBnaXZlbiB0byByZWFjdC1saXZlLWNoYXQtbG9hZGVyJylcbiAgICAgICAgcmV0dXJuXG4gICAgICB9XG5cbiAgICAgIGlmICghcHJvdmlkZXIpIHtcbiAgICAgICAgLy9lc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tY29uc29sZVxuICAgICAgICBjb25zb2xlLmVycm9yKCdObyBwcm92aWRlciBnaXZlbiB0byByZWFjdC1saXZlLWNoYXQtbG9hZGVyJylcbiAgICAgICAgcmV0dXJuXG4gICAgICB9XG5cbiAgICAgIGlmIChzdGF0ZSA9PT0gJ29wZW5pbmcnKSByZXR1cm5cbiAgICAgIGlmIChzdGF0ZSA9PT0gJ29wZW4nKSByZXR1cm4gY2hhdFByb3ZpZGVyLmNsb3NlKClcbiAgICAgIGlmIChzdGF0ZSA9PT0gJ2NvbXBsZXRlJykgcmV0dXJuIGNoYXRQcm92aWRlci5vcGVuKClcblxuICAgICAgaWYgKCFzY3JpcHRMb2FkZWQpIHtcbiAgICAgICAgc2NyaXB0TG9hZGVkID0gdHJ1ZVxuICAgICAgICBjaGF0UHJvdmlkZXIubG9hZCh7IHByb3ZpZGVyS2V5LCBzZXRTdGF0ZSwgYXBwSUQsIGxvY2FsZSB9KVxuICAgICAgfVxuXG4gICAgICBpZiAob3Blbikge1xuICAgICAgICBzZXRTdGF0ZSgnb3BlbmluZycpXG4gICAgICAgIGNoYXRQcm92aWRlci5vcGVuKClcbiAgICAgICAgc2V0U3RhdGUoJ29wZW4nKVxuICAgICAgfVxuICAgIH0sXG4gICAgW11cbiAgKVxuXG4gIHJldHVybiBbc3RhdGUsIGxvYWRDaGF0XVxufVxuXG5leHBvcnQgZGVmYXVsdCB1c2VDaGF0XG4iXX0=